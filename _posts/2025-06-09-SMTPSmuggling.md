---
title: ["[Research] - Email Spoofing with SMTP Smuggling: How the Shared Email Infrastructures Magnify this Vulnerability"]
date: 2025-06-09 09:00:00 +0900
last_modified_at: 2025-06-09 09:00:00 +0900
categories: [research, SMTP Smuggling]
tags: [research]
---

> Wang, C., Wang, C., Yang, S., Liu, S., Chen, J., Duan, H., & Wang, G. Email Spoofing with SMTP Smuggling: How the Shared Email Infrastructures Magnify this Vulnerability.

***
## 개요
SMTP Smuggling은 이메일 인증 기술(SPF, DKIM, DMARC)을 우회하면서도 **실제 인증을 통과한 것처럼 보이게 만드는** 메일을 전달할 수 있음.

기존 이메일 인프라가 얼마나 취약한지 수천 개의 도메인, 공개 이메일 서비스, 오픈소스 소프트웨어를 대상으로 실험하여 입증함.

### SMTP Smuggling이란?

SMTP Smuggling은 **SMTP 명령어와 데이터의 경계를 혼란시켜** 한 번의 세션에 **두 개의 이메일**을 전송하게 만드는 기법임.  
RFC에 명시된 종료 문자인 `\r\n.\r\n` 이외의 변종 종료 구문들(`\n.\n`, `\r.\r`, `\x00` 등)을 수신 서버가 잘못 처리하면 발생함.

### 공격 흐름
1. 공격자는 `alice@a.com` 계정으로 정상적인 이메일을 보냄.
2. 이메일 본문에 `\n.\nMAIL FROM:admin@a.com...`과 같은 SMTP 명령을 삽입함.
3. 수신 서버가 `\n.\n`을 종료로 오해해 이메일을 둘로 나눔.
4. 두 번째 이메일(`admin@a.com` 발신처럼 보이는 메일)은 SPF, DKIM, DMARC를 모두 통과함.

***
## 연구 목표

- **SMTP Smuggling의 실질적인 영향**이 과소평가되었다고 판단함.
- 취약점 공개 후 8개월이 지났지만, **커뮤니티가 얼마나 대응했는지 실태 조사**가 필요하다고 봄.
- **이메일 인프라의 중앙화 구조(SPF 공유 등)** 가 취약점을 증폭시킨다는 가설을 검증하고자 함.

***
## 실험 구성
### 테스트 대상

| 범주                       | 수량                                          |
| -------------------------- | --------------------------------------------- |
| 공개 이메일 서비스         | 22개                                          |
| 프라이빗 도메인            | 10,000개 중 1,577개 취약                      |
| 오픈소스 이메일 소프트웨어 | 5종 (Postfix, Exim, Sendmail, Haraka, Axigen) |
| 이메일 보안 게이트웨이     | 2종 (TrendMicro, Sophos)                      |

### 테스트 방식 요약

- **수신자 측 MTA 테스트 (Table 2)**  
  → 페이로드가 수신 측에서 분리되어 처리되는지 확인

- **발신자 측 MTA 테스트 (Table 3)**  
  → 공격 페이로드가 그대로 송신되는지 확인


## Table 2 - 수신자 측 MTA 취약성

| 이메일 서비스 | A1 (`\n.\n`)    | A5 (`\n.\r\n`) | 총 평가            | 비고                                       |
| ------------- | --------------- | -------------- | ------------------ | ------------------------------------------ |
| Sina          | 취약            | 취약           | ✅ 취약             | 첫 번째 이메일은 삭제됨, smuggled만 수신됨 |
| Sohu          | 취약            | 취약           | ✅ 취약             | 복수 페이로드에 취약                       |
| Yandex        | 취약            | 취약           | ✅ 취약             |                                            |
| Fastmail      | 일부 거부       | 일부 수락      | ⚠️ 일부 취약        | 몇몇 페이로드는 거부됨                     |
| Gmail         | 안전            | 안전           | ❌ 안전             |                                            |
| Outlook       | 안전            | 안전           | ❌ 안전             |                                            |
| Yahoo         | 안전            | 안전           | ❌ 안전             |                                            |
| Mail.ru       | 자름(Truncated) | 자름           | ⚠️ 회피 가능성 있음 | 내용 일부만 보임                           |
| Daum.net      | 취약            | 취약           | ✅ 취약             |                                            |

총 8개 서비스가 수신 측에서 **공격 페이로드를 수락하거나 smuggled 메일을 생성**함.

---

## Table 3 - 발신자 측 MTA 취약성

| 이메일 서비스 | A1~A13 대응 결과       | 비고                                  |
| ------------- | ---------------------- | ------------------------------------- |
| Gmail         | A7~A13 통과 (✓)        | \x00 포함 페이로드를 필터링하지 못함  |
| Yahoo         | A7~A13 통과 (✓)        | 마찬가지로 null 문자 우회 가능        |
| Outlook       | 일부 페이로드 거부 (✗) | 비교적 안전                           |
| Fastmail      | 여러 페이로드 허용 (✓) | 다중 메일로 분할되어 발신됨           |
| Zoho          | 다수 통과 (✓)          | 대부분 필터링 실패                    |
| Haraka        | 전 페이로드 허용 (✓)   | 오픈소스 서버이자 심각하게 취약함     |
| Axigen        | 전 페이로드 허용 (✓)   | 수신 시 첫 메일 삭제, smuggled만 보냄 |

총 18개 서비스가 **발신 측에서도 공격자를 필터링하지 않음** → 실제 이메일 공격자가 이용할 수 있음.

--- 


## 조합 분석: 공격 가능한 서비스 페어

공격이 성공하려면 **발신 측과 수신 측이 모두 취약해야 함**.

- Gmail (발신자) + Daum.net (수신자) → 공격 성공
- Fastmail (발신자) + Sohu (수신자) → 공격 성공

총 20×22 = 440개 조합 중 **36개 조합이 exploitable**함.


## SMTP 인프라 중앙화 문제

### SPF 공유 구조

- 수많은 조직이 Gmail/Outlook의 SPF 레코드를 **공유함**
- Gmail 공유 도메인 수: 63,225개
- Outlook 공유 도메인 수: 81,718개

→ **공격자가 Gmail 계정 하나만 있어도** zoom.us, youtube.com, openai.com 등의 주소를 사칭 가능함.

---

## 대학/프라이빗 이메일 테스트

### 사용자 참여형 실험

- 48개 대학 이메일 시스템 대상
- 그중 **23개가 smuggling 공격에 취약**
- 가장 자주 성공한 페이로드는 A1 (`\n.\n`)과 A5 (`\n.\r\n`)

### DKIM 사이드채널 방식

- 이메일에 2개의 DKIM 서명을 삽입
- 수신 서버가 두 번째 서명을 조회하면 → split 발생한 것으로 판단
- 이 방식으로 **자동화된 대규모 비침습 테스트** 가능

---

## 대규모 테스트 결과

- Tranco Top 10,000 도메인 중 MX 레코드 보유: 7,497개
- 관리자 이메일(account@domain) 테스트 → 6,917개 수신 가능
- 이 중 **1,577개 도메인이 취약** (22.8%)

### 취약 도메인 예시:
- instagram.com (via Proofpoint)
- amazonaws.com (via Amazon)
- wikipedia.org (via Postfix)

---

## 소프트웨어별 취약성

| 소프트웨어    | 수신 취약성                | 발신 취약성        |
| ------------- | -------------------------- | ------------------ |
| Postfix 3.9.0 | 일부 페이로드에서 자름     | 일부 페이로드 통과 |
| Exim 4.97.1   | 안전                       | 일부 필터링 실패   |
| Haraka        | 심각하게 취약              | 전 페이로드 통과   |
| Axigen        | 수신 시 smuggled만 표시    | 전 페이로드 통과   |
| Sendmail      | 수신/발신 모두 비교적 안전 | RFC 준수함         |

---

## 보안 대응 방안

### 수신 측 (Receiving MTA)
- **비표준 종료 문자열 차단**
- **SMTP Pipelining 비활성화**
- **DKIM 서명 강화**

### 발신 측 (Sending MTA)
- 이메일 본문 **Base64 인코딩**
- **Dot Stuffing** 적용
- **Null 문자(\x00)** 필터링

---

## 자가진단 도구

> 논문 저자가 만든 온라인 자가진단 도구  
🔗 [https://smuggling.breakspf.cloud](https://smuggling.breakspf.cloud)

---

## 결론

SMTP Smuggling은 단순한 프로토콜 오용이 아닌, **인증 체계 자체를 무력화할 수 있는 구조적 문제**임.  
특히 Gmail, Outlook 같은 대형 서비스가 SPF를 수천 개 도메인과 공유하는 상황에서 이 취약점은 **폭발적인 영향력**을 가짐.

조직은 반드시 자체 이메일 서비스의 **수신 및 발신 시스템에 대한 검증**이 필요하며,  
이 글에 정리된 테스트 방법 및 페이로드들을 바탕으로 **자체 보안 점검을 수행해야 함.**