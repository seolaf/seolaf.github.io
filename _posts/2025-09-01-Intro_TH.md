---
title: ["[SPLK] Introduction to Threat Hunting"]
date: 2025-09-01 09:00:00 +0900
last_modified_at: 2025-09-01 09:00:00 +0900
categories: [research, splunk]
tags: [splunk, Threat Hunting, PEAK]
---

## 왜 Threat Hunting이 필요한가?
많은 조직이 이미 자동화된 탐지 시스템을 갖추고 있음에도 불구하고 **Threat Hunting**이 중요한 이유는 간단하다.  
- 공격자는 인간이며, 예측 불가능한 행동을 한다.
- 알려진 탐지 기법을 회피하며 자동화된 시스템이 놓칠 수 있는 다양한 변수를 만든다.
- 따라서, 헌팅은 단순히 놓친 이벤트를 잡는 것 이상으로, **탐지 체계 개선**과 **제로데이 공격 대응**에 큰 역할을 한다.

## Threat Hunting의 주요 가치
1. **자동화 보완** → 기존 탐지 시스템이 놓치는 부분을 메움
2. **데이터 수집 개선** → 사각지대 파악 및 보완
3. **환경 이해도 향상** → SOC 분석가들이 환경을 더 잘 이해하고 triage 속도 향상
4. **misconfig, 취약점 발견** → 자주 리뷰되지 않는 영역에서 새로운 문제 식별
5. **프로액티브 접근** → 단순히 반응적 대응이 아닌 선제적 리스크 완화

## Threat Hunting과 SOC Analyst의 성장
- 단순히 경보(Alert)에만 의존하면 보이지 않는 데이터 누락을 헌팅 과정에서 발견 가능
- 고품질 SPL(Query) 작성 능력을 키워 탐지 개발·조사·기존 탐지 개선에 활용
- SOC 구성원의 기술 성장과 분석력 향상에 크게 기여

## PEAK 프레임워크
1. Prepare (준비)  
- 헌트 주제 선정, 사전 리서치, 계획 수립
- 성공적인 헌트를 위한 기반 마련

2. Execute (실행)
- 실제 헌트 수행
- 위협을 발견하거나 새로운 경로를 찾아내며 필요시 계획을 조정

3. Act (행동)
- 헌트 결과를 문서화·자동화·공유
- 사건을 찾지 못해도 탐지를 개선하고, 새로운 아이디어를 기록하며 조직 보안 태세를 강화

4. Knowledge (지식)
- 모든 단계는 지식(조직 이해, 과거 경험, 위협 인텔리전스)을 기반으로 수행
- 동시에 헌트를 통해 새로운 지식을 축적

## 헌트 결과의 다양한 가치
헌트가 위협을 직접 발견하지 않아도 여전히 많은 가치를 창출한다.  
- 탐지 개선 제안 및 신규 탐지 생성
- 데이터/도구/프로세스의 격차 확인 및 리스크 보고
- 향후 수행할 헌트 아이디어 축적
- 헌트 브리핑 준비 → 팀·관리자·툴 오너에게 환경 이해 제공

즉, Threat Hunting은 단순히 “위협 찾기”에 그치지 않고, **조직 보안 운영 전반을 성숙시키는 학습 과정**이다.


## Hypothesis-driven Threat Hunting
### Hypothesis-driven Hunting
Threat Hunting은 과학적 실험과 유사하다.
- **아이디어(가설)**를 세우고 → **연구**를 통해 범위를 좁히고 → **증거**를 찾아 **검증**하거나 **반증**하는 과정
- 중요한 점은 “옳은 가설”이 반드시 악성 행위를 발견해야 한다는 의미가 아니라, **테스트 가능하고 입증 가능한 가설**이어야 한다는 것

### ABLE Method - 가설 수립 도구
PEAK 프레임워크의 **Prepare 단계**에서는 **ABLE 방법론**을 활용해 헌트 목표를 구체화한다.
- **Actor** – 특정 위협 행위자(또는 그룹)가 관련되어 있다면 기록
- **Behavior** – 구체적으로 찾으려는 행위 정의 (예: 단순 “데이터 유출”이 아니라, “클라우드 스토리지로의 대용량 전송”)
- **Location** – 헌트가 이루어질 네트워크·자산 위치 지정
- **Evidence** – 가설을 입증·반증할 수 있는 데이터 소스와 로그 유형

### Hypothesis-driven Threat Hunting 실습 예시
#### 시나리오
시나리오: 랜섬웨어 관련 위협 헌트
- 최신 위협 인텔리전스에 따르면 업계가 랜섬웨어 공격에 노출됨
- MITRE ATT&CK T1059 (Command and Scripting Interpreter) 기법 활용 가능
- Cl0p 랜섬웨어 사례 분석: 보안 제품(Windows Defender 등)을 비활성화하는 행위 확인
- 최종 가설:
  > “공격자는 Windows Defender를 비활성화하여 탐지를 회피하려 한다.”

#### Scope & Plan
무제한적으로 헌트하지 않고 범위를 좁히는 것이 중요  
- 예시:
  - 모든 Windows 자산이 아니라 특정 사용자 그룹만 대상으로 설정
  - 기간도 1년치 로그 대신 최근 몇 주만 분석
  - 방법 역시 여러 탐지 기법 중 하나를 선택해 시작
- 체크리스트:
  - xmlwineventlog 소스타입 수집 여부
  - Sysmon 이벤트 정상 수집 여부
  - Endpoint 데이터 모델(CIM) 태그 매핑 확인

#### Execute
- 실제 데이터 분석 수행
- 로그 포맷 문제, 타임스탬프 불일치 등 사전 정제 필요
- 패턴·이상징후를 탐지하고 필요시 가설·범위 조정
- 중요한 발견이 있으면 Incident Response 팀에 즉시 전달
- 탐색 과정은 Prepare ↔ Execute 사이에서 여러 번 왕복할 수 있음

#### Act
- 헌트 결과를 반드시 기록·공유
- 신규 탐지 규칙 생성, 기존 탐지 개선, 자동화된 스케줄 탐지 설정 등으로 반영
- 헌트에서 배운 교훈과 아이디어를 문서화해 팀 지식으로 축적

## Baseline Threat Hunting
- **Baseline**: 네트워크/시스템의 "정상(normal)" 활동을 통계적으로 요약한 값
- 공격자는 정상 패턴에서 벗어나는 행동을 하기 때문에, **편차**를 추적하면 위협을 조기에 발견할 수 있다.
- 예시:
  - 일반적으로 하루 5회 로그인 시도가 정상인데 → 갑자기 100회 발생 → 비인가 접근 가능성
  - 새벽 2시에 대량 트래픽 발생 → 데이터 탈취 시도 의심
즉, **정상 행동을 먼저 정의하고, 벗어난 행동을 헌팅하는 방식**이다.

### Baseline Hunting과 Hypothesis Hunting의 차이
- **Hypothesis-driven Hunting**: 특정 주제나 위협 시나리오(가설)에서 출발
- **Baseline Hunting**: 특정 데이터셋에서 시작 → 정상 패턴 이해 → 편차를 기반으로 위협 찾기
두 방식 모두 **PEAK Framework (Prepare, Execute, Act with Knowledge)** 단계를 공유한다.

### Execute 단계의 핵심 활동
1. 데이터 수집 (Gather Data)
- Scope에 맞게 특정 sourcetype, 사용자 그룹, 기간 등을 제한
- 정상 시기(업무 시간, 특정 주기)를 기준으로 데이터 선택
2. 데이터 딕셔너리 작성 (Create a Data Dictionary)
- 필드 이름, 타입(숫자/카테고리/날짜), 의미 정리
- 분석에 중요한 필드만 기록 (예: src_ip, bytes_out, severity)
3. 분포 검토 (Review Distributions)
- 평균(mean), 중앙값(median), 최빈값(mode)
- 데이터의 고유값 개수(cardinality) 확인
- 이상치(outlier) 후보를 찾는 기초 작업

### Threat Hunter Toolbox – 통계 기법
통계를 통해 **“정상 범위”**와 **“이상치”**를 정의한다.  
- Mean (평균): 데이터 중심값. 하지만 outlier에 민감
- Median (중앙값): 편향된 데이터에 더 적합한 대표값
- Standard Deviation (표준편차, σ): 데이터 분산 정도
- Z-score (표준점수): 평균에서 2~3σ 벗어난 값 → 이상치 가능성
- IQR (Interquartile Range): 데이터셋을 4분위(Q1, Q2, Q3)로 나눠 정상 범위를 정의. Box Plot으로 시각화 가능

예시:
- `bytes_out` 값이 전체 평균 대비 3σ 이상 높으면 → 데이터 유출 시도 가능성
- 새벽 시간대 비정상적으로 많은 `auth_failure` 발생 → 계정 탈취 의심


## Model-Assisted Threat Hunting (M-ATH)
- 머신러닝(ML)과 같은 **모델 기반 기법**을 활용해 의심스러운 행동 패턴을 탐지
- 주제(Topic)는 명확하지만, 단순 규칙 기반으로는 다루기 어려운 복잡성이 있을 때 적합

### 왜 M-ATH가 필요한가?
예를 들어, 사람이 URL을 보면서 “이상하다”라고 직감할 수는 있다.  
- 무작위 문자 조합
- 철자 오류(typosquatting)
- 예상치 않은 상위 도메인 사용

하지만 이런 직관을 **정규식(Regex) 하나로 정의하기는 불가능**하다.  
대신, 모델을 학습시켜 **“수상한 URL” 패턴을 자동 인식**하게 만들면,  
- SOC 분석가의 시간 절약
- 기존 탐지 규칙으로는 잡기 힘든 트래픽을 부각 가능

### M-ATH 절차 개요
M-ATH는 전형적인 데이터 사이언스 프로세스를 단순화한 형태다.
1. 주제 정의
  - 해결하고자 하는 위협 영역을 설정
  - 예: “수상한 URL 패턴 탐지”
2. 데이터 준비
  - 관련 로그와 이벤트를 수집 및 정제
  - 불필요한 값 제거, 형식 변환
3. 특징(feature) 추출
  - 데이터를 모델 학습에 유용한 형태로 변환
  - 예: URL 길이, 포함된 문자 종류, 상위 도메인
4. 모델 학습 (Training)
  - 지도학습/비지도학습 등 적절한 ML 알고리즘 적용
  - 데이터셋 일부를 학습용, 일부를 검증용으로 분리
5. 평가 및 반복
  - 탐지 정확도(Precision, Recall) 검증
  - 필요 시 데이터/특징/모델 개선
6. 실행 및 적용
  - 학습된 모델을 운영 환경에 배치
  - 새 데이터에 대해 “이상 행위 가능성” 자동 판별